install:
  - dart pub global deactivate import_ozempic || true
  - rm -rf .dart_tool
  - rm pubspec.lock
  - dart pub get
  - dart pub global activate --source path . --overwrite

lint: dart analyze . --fatal-infos --fatal-warnings

publish:
  (bail):
  (command):
    - "{$lint}"
    - sip test -rbc
    - "{$publish:sync-versions}"
    - dart pub publish
    - "{$publish:commit}"
    - "{$publish:tag}"
    - "{$publish:_push}"
  sync-versions: |
    # Sync changelog and pubspec versions
    version=$(grep -m 1 "## " CHANGELOG.md | awk '{print $2}')

    echo "Updating pubspec.yaml version to $version"
    sed -i '' "s|^version: .*|version: $version|g" "pubspec.yaml"

    echo "Updating version.dart file"
    echo "const version = '$version';" > "lib/gen/version.dart"
  commit: |
    # get version from changelog
    version=$(grep -m 1 "## " CHANGELOG.md | awk '{print $2}')

    echo "Committing version $version"
    git add . || true
    git commit -m "v$version" --allow-empty
  tag: |
    # get version from changelog
    version=$(grep -m 1 "## " CHANGELOG.md | awk '{print $2}')

    echo "Tagging version $version"
    git tag -a "v$version" -m "v$version"
  _push: |
    echo "Pushing to origin"
    git push
    git push --tags
